<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ‰“è€…æˆç¸¾æŸ¥è©¢</title>
  <style>
    body { font-family: system-ui, "Noto Sans TC", Arial; margin: 24px; background-color: #f0f2f5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h1 { margin: 0 0 16px; font-size: 28px; color: #333; }
    .note-readonly {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      padding: 12px 16px;
      margin-bottom: 16px;
      border-radius: 4px;
      font-size: 14px;
    }
    .controls { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
    input, select, button { padding: 10px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
    button { background-color: #f0f0f0; cursor: pointer; }
    button:hover { background-color: #e0e0e0; }
    .table-wrapper { overflow: auto; max-height: 65vh; border-top: 1px solid #eee; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: center; white-space: nowrap; }
    /* Combined thead rules for clarity. */
    thead { position: sticky; top: 0; z-index: 2; background: #f9f9f9; }
    th { background: #f9f9f9; }
    thead.is-sticky {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: box-shadow 0.2s ease-in-out;
    }

    th:nth-child(1), td:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 1;
      border-right: 1px solid #ddd;
    }

    th:nth-child(2), td:nth-child(2) {
      position: sticky;
      z-index: 1;
      border-right: 1px solid #ddd;
      /* 'left' is set by JS */
    }

    /* Set backgrounds for sticky columns */
    td:nth-child(1), td:nth-child(2) { background-color: #fff; }
    thead th:nth-child(1), thead th:nth-child(2) { background-color: #f9f9f9; z-index: 3; }


    @media (max-width: 768px) {
      body { margin: 0; background-color: #fff; }
      .container { padding: 15px; border-radius: 0; box-shadow: none; }
      h1 { font-size: 22px; }
      .controls { flex-direction: column; }
      input, select, button { width: 100%; box-sizing: border-box; }
    }
  </style>
</head>
<body>



<div class="container">
  <h1>å°ä¸­å¸‚ CBL ä¼æ¥­äº¤æµè¯ç›Ÿ æ‰“è€…æˆç¸¾æŸ¥è©¢</h1>


  <p style="font-size: 14px; color: #666; margin-bottom: 16px;">æˆç¸¾æ›´æ–°æ™‚é–“ï¼š<span id="last-updated">è®€å–ä¸­...</span></p>

  <div class="note-readonly">
    âš ï¸ æç¤ºï¼šæ­¤é é¢åƒ…ä¾›æŸ¥è©¢çƒå“¡æˆç¸¾ï¼Œä½¿ç”¨è€…ç„¡æ³•ä¿®æ”¹è³‡æ–™ã€‚
  </div>

  <div class="controls">
    <input id="search" type="text" placeholder="æœå°‹ï¼šçƒå“¡å§“å" />
    <select id="team"><option value="">å…¨éƒ¨çƒéšŠ</option></select>
    <select id="season"><option value="">å…¨éƒ¨è³½å­£</option></select>
  </div>

  <div class="table-wrapper">
    <table id="table">
      <thead><tr id="header-row"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

  <script>
    // ğŸ‘‡ åœ¨é€™è£¡è²¼ä¸Š Google è©¦ç®—è¡¨ã€Œç™¼ä½ˆåˆ°ç¶²è·¯ã€çš„ CSV é€£çµ
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_X5jYPR24dk5oqUSr1py8glTu-jHZJwuzhyJN7RrjMkgkXjwv0hVgmn7KlieQy_-CZEn6UQofqTbz/pub?gid=546432089&single=true&output=csv";

    const searchInput = document.getElementById('search');
    const teamSelect = document.getElementById('team');
    const seasonSelect = document.getElementById('season');
    const headerRow = document.getElementById('header-row');
    const tbody = document.getElementById('tbody');
    let rows = [], headers = [];

    async function fetchCSV() {
      try {
        const res = await fetch(CSV_URL);
        if (!res.ok) throw new Error('è®€å–å¤±æ•—ï¼šHTTP ' + res.status);
        const text = await res.text();
        parseCSV(text); // Populates global 'headers' and 'rows'

        const AC1_COLUMN_INDEX = 28; // 0-indexed for 29th column

        // Extract and display update time
        const updateTimeElement = document.getElementById('last-updated');
        if (updateTimeElement && headers.length > AC1_COLUMN_INDEX) {
          const updateTimeFromAC1 = headers[AC1_COLUMN_INDEX];
          if (updateTimeFromAC1) {
            updateTimeElement.textContent = updateTimeFromAC1;
          } else {
            updateTimeElement.textContent = 'ç„¡æ³•å–å¾—æ›´æ–°æ™‚é–“ (AC1 ç‚ºç©º)';
          }
        } else if (updateTimeElement) {
          updateTimeElement.textContent = 'CSVè³‡æ–™ä¸è¶³ (ç„¡ AC1 æ¬„ä½)';
        }

        // Create displayHeaders for rendering (excluding AC1)
        window.displayHeaders = headers.filter((_, index) => index !== AC1_COLUMN_INDEX);

        // Set headerRow.innerHTML here, after window.displayHeaders is defined
        headerRow.innerHTML = window.displayHeaders.map(h => {
          if (h.includes('æ‰“æ“Šç‡')) {
            return `<th>${h} <span id="sort-avg-toggle" style="cursor: pointer;"></span></th>`;
          }
          return `<th>${h}</th>`;
        }).join('');

        buildFilters(); // Uses global 'headers' and 'rows'
        render(); // Uses global 'rows' and 'window.displayHeaders'

        let sortOrder = 'none'; // none, 'asc', 'desc'
        const sortAvgToggle = document.getElementById('sort-avg-toggle');

        if (sortAvgToggle) {
          sortAvgToggle.innerHTML = '&#9670;'; // Initial: lozenge
          sortAvgToggle.addEventListener('click', () => {
            if (sortOrder === 'desc') {
              sortOrder = 'asc';
              sortAvgToggle.innerHTML = '&#9650;'; // Up arrow
            } else {
              sortOrder = 'desc';
              sortAvgToggle.innerHTML = '&#9660;'; // Down arrow
            }

            const avgKey = headers.find(h => h.includes('æ‰“æ“Šç‡'));
            if (avgKey) {
              rows.sort((a, b) => {
                const avgA = parseFloat(a[avgKey]);
                const avgB = parseFloat(b[avgKey]);
                if (isNaN(avgA)) return 1;
                if (isNaN(avgB)) return -1;

                if (sortOrder === 'asc') {
                  return avgA - b[avgKey];
                } else {
                  return avgB - a[avgKey];
                }
              });
              render();
            }
          });
        }
      } catch (err) {
        tbody.innerHTML = '<tr><td>' + err.message + '</td></tr>';
      }
    }

    function parseCSV(text) {
      const lines = text.replace(/\r/g,'').split('\n').filter(l => l.trim() !== '');
      headers = splitCSVLine(lines[0]).map(h => h.trim());
      rows = lines.slice(1).map(line => {
        const cells = splitCSVLine(line);
        const obj = {};
        headers.forEach((h,i)=> obj[h] = (cells[i]||'').trim());
        return obj;
      });
      headerRow.innerHTML = headers.map(h => {
        if (h.includes('æ‰“æ“Šç‡')) {
          return `<th>${h} <span id="sort-avg-toggle" style="cursor: pointer;"></span></th>`;
        }
        return `<th>${h}</th>`;
      }).join('');
    }

    function splitCSVLine(line) {
      const out=[]; let cur='', inQuotes=false;
      for (let i=0; i<line.length; i++) {
        const c=line[i], n=line[i+1];
        if (c === '"' && inQuotes && n === '"') { cur += '"'; i++; }
        else if (c === '"') { inQuotes = !inQuotes; }
        else if (c === ',' && !inQuotes) { out.push(cur); cur=''; }
        else { cur += c; }
      }
      out.push(cur);
      return out;
    }

    function buildFilters() {
      const teamKey = headers.find(h => h.includes('éšŠ')) || "éšŠä¼";
      const seasonKey = headers.find(h => h.includes('è³½å­£')) || "è³½å­£";
      const nameKey = headers.find(h => h.includes('å§“å')) || "èƒŒè™Ÿ/å§“å";
      const teams = [...new Set(rows.map(r => r[teamKey]).filter(Boolean))].sort();
      const seasons = [...new Set(rows.map(r => r[seasonKey]).filter(Boolean))].sort().reverse();
      teamSelect.innerHTML = '<option value="">å…¨éƒ¨çƒéšŠ</option>' + teams.map(t=>`<option>${t}</option>`).join('');
      seasonSelect.innerHTML = '<option value="">å…¨éƒ¨è³½å­£</option>' + seasons.map(s=>`<option>${s}</option>`).join('');
      [searchInput,teamSelect,seasonSelect].forEach(el=>el.addEventListener('input',render));
      searchInput.dataset.nameKey=nameKey; teamSelect.dataset.teamKey=teamKey; seasonSelect.dataset.seasonKey=seasonKey;
    }

    function updateStickyColumns() {
      const firstCol = document.querySelector('#table th:nth-child(1)');
      if (!firstCol) return;
      const firstColWidth = firstCol.offsetWidth;
      
      const secondColElems = document.querySelectorAll('#table th:nth-child(2), #table td:nth-child(2)');
      secondColElems.forEach(elem => {
        elem.style.left = firstColWidth + 'px';
      });
    }

    function render() {
      const nameKey=searchInput.dataset.nameKey, teamKey=teamSelect.dataset.teamKey, seasonKey=seasonSelect.dataset.seasonKey;
      const kw=searchInput.value.trim().toLowerCase(), team=teamSelect.value, season=seasonSelect.value;
      const filtered=rows.filter(r=>{
        const passName=kw?String(r[nameKey]||'').toLowerCase().includes(kw):true;
        const passTeam=team?r[teamKey]===team:true;
        const passSeason=season?r[seasonKey]===season:true;
        return passName && passTeam && passSeason;
      });
      tbody.innerHTML=filtered.map(r=>`<tr>`+window.displayHeaders.map(h=>`<td>${r[h]??''}</td>`).join('')+`</tr>`).join('')
        || `<tr><td colspan="${window.displayHeaders.length}">æ‰¾ä¸åˆ°ç¬¦åˆçš„è³‡æ–™</td></tr>`;
      
      // Update sticky columns after rendering table
      updateStickyColumns();
    }

    window.addEventListener('resize', updateStickyColumns);

    fetchCSV();

    // Observer for sticky header shadow
    try {
      const thead = document.querySelector('#table thead');
      if (thead) {
        const observer = new IntersectionObserver(
          ([e]) => thead.classList.toggle('is-sticky', e.intersectionRatio < 1),
          { threshold: [1] }
        );
        observer.observe(thead);
      }
    } catch (e) {
      console.error('Sticky header observer failed:', e);
    }
  </script>

</body>
</html>