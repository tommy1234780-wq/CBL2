<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>投手成績查詢</title>
  <style>
    body { font-family: system-ui, "Noto Sans TC", Arial; margin: 24px; background-color: #f0f2f5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h1 { margin: 0 0 16px; font-size: 28px; color: #333; }
    .note-readonly {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      padding: 12px 16px;
      margin-bottom: 16px;
      border-radius: 4px;
      font-size: 14px;
    }
    .controls { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
    input, select, button { padding: 10px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
    button { background-color: #f0f0f0; cursor: pointer; }
    button:hover { background-color: #e0e0e0; }
    .table-wrapper { overflow: auto; max-height: 65vh; border-top: 1px solid #eee; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: center; white-space: nowrap; }
    /* Combined thead rules for clarity. */
    thead { position: sticky; top: 0; z-index: 2; background: #f9f9f9; }
    th { background: #f9f9f9; }
    thead.is-sticky {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: box-shadow 0.2s ease-in-out;
    }

    th:nth-child(1), td:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 1;
      border-right: 1px solid #ddd;
    }

    th:nth-child(2), td:nth-child(2) {
      position: sticky;
      z-index: 1;
      border-right: 1px solid #ddd;
      /* 'left' is set by JS */
    }

    /* Set backgrounds for sticky columns */
    td:nth-child(1), td:nth-child(2) { background-color: #fff; }
    thead th:nth-child(1), thead th:nth-child(2) { background-color: #f9f9f9; z-index: 3; }


    @media (max-width: 768px) {
      body { margin: 0; background-color: #fff; }
      .container { padding: 15px; border-radius: 0; box-shadow: none; }
      h1 { font-size: 22px; }
      .controls { flex-direction: column; }
      input, select, button { width: 100%; box-sizing: border-box; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>台中市 CBL 企業交流聯盟 投手成績查詢</h1>

  <p style="font-size: 14px; color: #666; margin-bottom: 16px;">成績更新時間：<span id="last-updated">讀取中...</span></p>

  <div class="note-readonly">
    ⚠️ 提示：此頁面僅供查詢投手成績，使用者無法修改資料。
  </div>

  <div class="controls">
    <input id="search" type="text" placeholder="搜尋：背號/姓名" />
    <select id="team"><option value="">全部球隊</option></select>
    <select id="season"><option value="">全部賽季</option></select>
  </div>

  <div class="table-wrapper">
    <table id="table">
      <thead><tr id="header-row"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

  <script>
    // 👇 把這裡換成 Google 試算表 CSV 連結
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTmnSzqJij7qN0DkHrUHSTUbQv609l1OkQU-1BlZqO2t2Jry0zvcMyQa1DpbGKYSXtF94pg2CU-I3X8/pub?gid=1969750057&single=true&output=csv";

    const searchInput = document.getElementById('search');
    const teamSelect = document.getElementById('team');
    const seasonSelect = document.getElementById('season');
    const headerRow = document.getElementById('header-row');
    const tbody = document.getElementById('tbody');
    let rows = [], headers = [];

    async function fetchCSV() {
      try {
        const res = await fetch(CSV_URL);
        if (!res.ok) throw new Error('讀取失敗：HTTP ' + res.status);
        const text = await res.text();
        parseCSV(text); // Populates global 'headers' and 'rows'

        const AA1_COLUMN_INDEX = 26; // 0-indexed for 27th column (AA1)

        // Extract and display update time
        const updateTimeElement = document.getElementById('last-updated');
        if (updateTimeElement && headers.length > AA1_COLUMN_INDEX) {
          const updateTimeFromAA1 = headers[AA1_COLUMN_INDEX];
          if (updateTimeFromAA1) {
            updateTimeElement.textContent = updateTimeFromAA1;
          } else {
            updateTimeElement.textContent = '無法取得更新時間 (AA1 為空)';
          }
        } else if (updateTimeElement) {
          updateTimeElement.textContent = 'CSV資料不足 (無 AA1 欄位)';
        }

        // Create displayHeaders for rendering (excluding AA1)
        window.displayHeaders = headers.filter((_, index) => index !== AA1_COLUMN_INDEX);

        // Set headerRow.innerHTML here, after window.displayHeaders is defined
        headerRow.innerHTML = window.displayHeaders.map(h => {
          if (h.includes('勝投')) {
            return `<th>${h} <span id="sort-wins-toggle" style="cursor: pointer;"></span></th>`;
          }
          if (h.includes('防禦率')) {
            return `<th>${h} <span id="sort-era-toggle" style="cursor: pointer;"></span></th>`;
          }
          return `<th>${h}</th>`;
        }).join('');

        buildFilters(); // Uses global 'headers' and 'rows'
        render(); // Uses global 'rows' and 'window.displayHeaders'

        let winsSortOrder = 'none'; // none, 'asc', 'desc'
        const sortWinsToggle = document.getElementById('sort-wins-toggle');

        if (sortWinsToggle) {
          sortWinsToggle.innerHTML = '&#9670;'; // Initial: lozenge
          sortWinsToggle.addEventListener('click', () => {
            if (winsSortOrder === 'desc') {
              winsSortOrder = 'asc';
              sortWinsToggle.innerHTML = '&#9650;'; // Up arrow
            } else {
              winsSortOrder = 'desc';
              sortWinsToggle.innerHTML = '&#9660;'; // Down arrow
            }

            const winKey = headers.find(h => h.includes('勝投'));
            if (winKey) {
              rows.sort((a, b) => {
                const winA = parseInt(a[winKey], 10);
                const winB = parseInt(b[winKey], 10);
                if (isNaN(winA)) return 1;
                if (isNaN(winB)) return -1;

                if (winsSortOrder === 'asc') {
                  return winA - winB;
                } else {
                  return winB - winA;
                }
              });
              render();
            }
          });
        }

        let eraSortOrder = 'none'; // none, 'asc', 'desc'
        const sortEraToggle = document.getElementById('sort-era-toggle');

        if (sortEraToggle) {
          sortEraToggle.innerHTML = '&#9670;'; // Initial: lozenge
          sortEraToggle.addEventListener('click', () => {
            if (eraSortOrder === 'asc') {
              eraSortOrder = 'desc';
              sortEraToggle.innerHTML = '&#9660;'; // Down arrow
            } else {
              eraSortOrder = 'asc';
              sortEraToggle.innerHTML = '&#9650;'; // Up arrow
            }

            const eraKey = headers.find(h => h.includes('防禦率'));
            if (eraKey) {
              rows.sort((a, b) => {
                const eraA = parseFloat(a[eraKey]);
                const eraB = parseFloat(b[eraKey]);
                if (isNaN(eraA)) return 1;
                if (isNaN(eraB)) return -1;

                if (eraSortOrder === 'asc') {
                  return eraA - eraB;
                } else {
                  return eraB - eraA;
                }
              });
              render();
            }
          });
        }
      } catch (err) {
        tbody.innerHTML = '<tr><td>' + err.message + '</td></tr>';
      }
    }

    function parseCSV(text) {
      const lines = text.replace(/\r/g,'').split('\n').filter(l => l.trim() !== '');
      headers = splitCSVLine(lines[0]).map(h => h.trim());
      rows = lines.slice(1).map(line => {
        const cells = splitCSVLine(line);
        const obj = {};
        headers.forEach((h,i)=> obj[h] = (cells[i]||'').trim());
        return obj;
      });
      headerRow.innerHTML = headers.map(h => {
        if (h.includes('勝投')) {
          return `<th>${h} <span id="sort-wins-toggle" style="cursor: pointer;"></span></th>`;
        }
        if (h.includes('防禦率')) {
          return `<th>${h} <span id="sort-era-toggle" style="cursor: pointer;"></span></th>`;
        }
        return `<th>${h}</th>`;
      }).join('');
    }

    function splitCSVLine(line) {
      const out=[]; let cur='', inQuotes=false;
      for (let i=0; i<line.length; i++) {
        const c=line[i], n=line[i+1];
        if (c === '"' && inQuotes && n === '"') { cur += '"'; i++; }
        else if (c === '"') { inQuotes = !inQuotes; }
        else if (c === ',' && !inQuotes) { out.push(cur); cur=''; }
        else { cur += c; }
      }
      out.push(cur);
      return out;
    }

    function buildFilters() {
      const teamKey = headers.find(h => h.includes('隊')) || "隊伍";
      const seasonKey = headers.find(h => h.includes('賽季')) || "賽季";
      const nameKey = headers.find(h => h.includes('姓名')) || "背號/姓名";
      const teams = [...new Set(rows.map(r => r[teamKey]).filter(Boolean))].sort();
      const seasons = [...new Set(rows.map(r => r[seasonKey]).filter(Boolean))].sort().reverse();
      teamSelect.innerHTML = '<option value="">全部球隊</option>' + teams.map(t=>`<option>${t}</option>`).join('');
      seasonSelect.innerHTML = '<option value="">全部賽季</option>' + seasons.map(s=>`<option>${s}</option>`).join('');
      [searchInput,teamSelect,seasonSelect].forEach(el=>el.addEventListener('input',render));
      searchInput.dataset.nameKey=nameKey; teamSelect.dataset.teamKey=teamKey; seasonSelect.dataset.seasonKey=seasonKey;
    }

    function updateStickyColumns() {
      const firstCol = document.querySelector('#table th:nth-child(1)');
      if (!firstCol) return;
      const firstColWidth = firstCol.offsetWidth;
      
      const secondColElems = document.querySelectorAll('#table th:nth-child(2), #table td:nth-child(2)');
      secondColElems.forEach(elem => {
        elem.style.left = firstColWidth + 'px';
      });
    }

    function render() {
      const nameKey=searchInput.dataset.nameKey, teamKey=teamSelect.dataset.teamKey, seasonKey=seasonSelect.dataset.seasonKey;
      const kw=searchInput.value.trim().toLowerCase(), team=teamSelect.value, season=seasonSelect.value;
      const filtered=rows.filter(r=>{
        const passName=kw?String(r[nameKey]||'').toLowerCase().includes(kw):true;
        const passTeam=team?r[teamKey]===team:true;
        const passSeason=season?r[seasonKey]===season:true;
        return passName && passTeam && passSeason;
      });
      tbody.innerHTML=filtered.map(r=>`<tr>`+window.displayHeaders.map(h=>`<td>${r[h]??''}</td>`).join('')+`</tr>`).join('')
        || `<tr><td colspan="${window.displayHeaders.length}">找不到符合的資料</td></tr>`;
      
      // Update sticky columns after rendering table
      updateStickyColumns();
    }

    window.addEventListener('resize', updateStickyColumns);

    fetchCSV();

    // Observer for sticky header shadow
    try {
      const thead = document.querySelector('#table thead');
      if (thead) {
        const observer = new IntersectionObserver(
          ([e]) => thead.classList.toggle('is-sticky', e.intersectionRatio < 1),
          { threshold: [1] }
        );
        observer.observe(thead);
      }
    } catch (e) {
      console.error('Sticky header observer failed:', e);
    }
  </script>
</body>
</html>