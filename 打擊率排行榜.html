<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>打擊率排行榜</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }

        @media screen and (max-width: 600px) {
            .table-container {
                overflow-x: auto;
            }
            body {
                font-size: 0.9em;
            }
            th, td {
                padding: 6px;
            }
        }
    </style>
</head>
<body>

    <h1>打擊率排行榜 <span style="font-size: 0.5em;">(當屆季賽總場數*1.7=入選打席數)</span></h1>

    <div class="table-container">
        <table>
        <thead>
            <tr>
                <th>排名</th>
                <th>球員</th>
                <th>隊伍</th>
                <th>打擊率</th>
            </tr>
        </thead>
        <tbody id="leaderboard-tbody">
            <!-- Data will be loaded dynamically -->
        </tbody>
    </table>
    </div>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_X5jYPR24dk5oqUSr1py8glTu-jHZJwuzhyJN7RrjMkgkXjwv0hVgmn7KlieQy_-CZEn6UQofqTbz/pub?gid=546432089&single=true&output=csv";
        const tbody = document.getElementById('leaderboard-tbody');

        async function fetchAndRenderLeaderboard() {
            try {
                const res = await fetch(CSV_URL);
                if (!res.ok) throw new Error('Failed to fetch CSV: HTTP ' + res.status);
                const text = await res.text();
                
                const lines = text.trim().split(/\n/);
                const headers = lines[0].split(',').map(h => h.trim());
                const data = lines.slice(1).map(line => {
                    const values = [];
                    let current_value = "";
                    let in_quotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        const next_char = line[i+1];
                        if (char === '"' && in_quotes && next_char === '"' ) {
                            current_value += '"' ;
                            i++;
                        } else if (char === '"' ) {
                            in_quotes = !in_quotes;
                        } else if (char === ',' && !in_quotes) {
                            values.push(current_value.trim());
                            current_value = "";
                        } else {
                            current_value += char;
                        }
                    }
                    values.push(current_value.trim());

                    const row_data = {};
                    headers.forEach((h, i) => row_data[h] = values[i] || "");
                    return row_data;
                });

                const player_key = headers.find(h => h.includes('姓名')) || '背號/姓名';
                const team_key = headers.find(h => h.includes('隊伍')) || '隊伍';
                const batting_avg_key = headers.find(h => h.includes('打擊率')) || '打擊率';
                const ab_key = headers.find(h => h.includes('打數')) || '打數';

                const filtered_data = [];
                for (const entry of data) {
                    let batting_avg;
                    try {
                        batting_avg = parseFloat(entry[batting_avg_key]);
                    } catch (e) {
                        batting_avg = 0.0; // Handle #DIV/0! or other non-numeric values
                    }
                    entry[batting_avg_key] = batting_avg;

                    let ab;
                    try {
                        ab = parseInt(entry[ab_key], 10);
                    } catch (e) {
                        ab = 0;
                    }
                    entry[ab_key] = ab;

                    if (ab >= 15) {
                        filtered_data.push(entry);
                    }
                }

                const sorted_data = filtered_data.sort((a, b) => b[batting_avg_key] - a[batting_avg_key]);

                let html_rows = "";
                let rank = 0;
                let last_score = -1;
                sorted_data.slice(0, 10).forEach((player, index) => {
                    if (player[batting_avg_key] !== last_score) {
                        rank = index + 1;
                    }
                    let rank_display = rank;
                    if (rank === 1) {
                        rank_display = '🏆';
                    }

                    const is_first = rank === 1;
                    const style = is_first ? ' style="color: red;"' : '';

                    html_rows += `
                        <tr>
                            <td>${rank_display}</td>
                            <td><span${style}>${player[player_key]}</span></td>
                            <td><span${style}>${player[team_key]}</span></td>
                            <td><span${style}>${player[batting_avg_key].toFixed(3)}</span></td>
                        </tr>
                    `;
                    last_score = player[batting_avg_key];
                });
                tbody.innerHTML = html_rows;

            } catch (error) {
                console.error("Error fetching or parsing CSV:", error);
                tbody.innerHTML = `<tr><td colspan="4">載入資料失敗: ${error.message}</td></tr>`;
            }
        }

        fetchAndRenderLeaderboard();
        setInterval(fetchAndRenderLeaderboard, 300000); // Refresh every 5 minutes
    </script>

</body>
</html>
